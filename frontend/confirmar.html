<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Confirmar Reserva</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
    <style>
      /* Estilos CSS */
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f2f2f2;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      h2 {
        text-align: center;
        margin-bottom: 20px;
      }
      p {
        margin-bottom: 10px;
      }
      .button-container {
        text-align: center;
      }
      button {
        padding: 10px 20px;
        border: none;
        border-radius: 20px;
        background-color: #e6f0ff;
        color: #0056b3;
        font-size: 16px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background-color: #cce0ff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Confirmar Reserva</h2>

      <p><strong>Sede:</strong> <span id="selectedSede"></span></p>
      <p><strong>Edificio:</strong> <span id="edificioSeleccionado"></span></p>
      <p><strong>Vehículo:</strong> <span id="vehiculoSeleccionada"></span></p>
      <p><strong>Estacionamiento:</strong> 1</p>
      <p>
        <strong>Hora Entrada de Reserva:</strong>
        <span id="horaEntradaSeleccionada"></span>
      </p>
      <p>
        <strong>Hora Salida de Reserva:</strong>
        <span id="horaSalidaSeleccionada"></span>
      </p>
      <!-- <p><strong>Tipo de Vehículo:</strong> Auto</p> -->
      <button id="confirmarReservaButton">Confirmar Reserva</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      // Obtener la hora seleccionada del localStorage
      const horaEntradaSeleccionada = localStorage.getItem(
        "horaEntradaSeleccionada"
      );
      const horaSalidaSeleccionada = localStorage.getItem(
        "horaSalidaSeleccionada"
      );
      const vehiculoSeleccionado = localStorage.getItem("vehiculoSeleccionada");
      const edificioSeleccionado = localStorage.getItem("edificioSeleccionado");
      const selectedSede = localStorage.getItem("selectedSede");

      // Convertir el valor de selectedSede a la sede correspondiente
      let sedeSeleccionada;
      if (selectedSede === "btnMeyer") {
        sedeSeleccionada = "Meyer";
      } else if (selectedSede === "btnChuyaca") {
        sedeSeleccionada = "Chuyaca";
      }

      // Mostrar la hora, vehículo y edificio seleccionados en la página
      document.getElementById("horaEntradaSeleccionada").innerText =
        horaEntradaSeleccionada || "No seleccionada";
      document.getElementById("horaSalidaSeleccionada").innerText =
        horaSalidaSeleccionada || "No seleccionada";
      document.getElementById("vehiculoSeleccionada").innerText =
        vehiculoSeleccionado || "No seleccionado";
      document.getElementById("edificioSeleccionado").innerText =
        edificioSeleccionado || "No seleccionado";
      document.getElementById("selectedSede").innerText =
        sedeSeleccionada || "No seleccionado";

      // Función para enviar los datos a la API
      async function confirmarReserva() {
        try {
          const response = await fetch("/usuarios/reserva", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}", // Asegúrate de que csrfToken esté definido
            },
            body: JSON.stringify({
              edificio: edificioSeleccionado,
              patente: vehiculoSeleccionado,
              id_espacio: "1",
              hora_entrada: horaEntradaSeleccionada,
              hora_salida: horaSalidaSeleccionada,
            }),
          });

          if (!response.ok) {
            throw new Error("Error en la solicitud: " + response.statusText);
          }

          const data = await response.json(); // Intenta parsear la respuesta JSON

          console.log("Respuesta del servidor:", data);

          if (data.json === 121 || data.json=== "Ya tienes una reserva") {
            // Mostrar mensaje Swal.fire si el status es 121
            Swal.fire({
              title: "Ya tienes una reserva hecha",
              text: "No puedes realizar otra reserva simultánea.",
              icon: "warning",
              confirmButtonText: "OK",
            });
          } else {
            // Mostrar mensaje de éxito si la reserva se guarda correctamente
            Swal.fire({
              title: "Reserva confirmada",
              text: "Tu reserva ha sido confirmada exitosamente.",
              icon: "success",
              confirmButtonText: "OK",
            });
          }
        } catch (error) {
          console.error("Error al guardar la reserva:", error);
          Swal.fire({
            title: "Error",
            text: "Hubo un problema al confirmar tu reserva.",
            icon: "error",
            confirmButtonText: "OK",
          });
        }
      }

      // Agregar el evento al botón
      document
        .getElementById("confirmarReservaButton")
        .addEventListener("click", confirmarReserva);
    </script>
  </body>
</html>
